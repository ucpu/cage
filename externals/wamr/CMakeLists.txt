cmake_minimum_required(VERSION 3.22)

message(STATUS "----------------------------------------------------------------")
message(STATUS "wamr")
message(STATUS "----------------------------------------------------------------")

if(NOT CMAKE_BUILD_TYPE)
	set(CMAKE_BUILD_TYPE Release)
endif()
string(TOLOWER ${CMAKE_HOST_SYSTEM_NAME} WAMR_BUILD_PLATFORM)
set(WAMR_BH_LOG cage_wamr_log)
set(WAMR_BH_VPRINTF cage_wamr_vprintf)
set(WAMR_BUILD_AOT 1)
set(WAMR_BUILD_BULK_MEMORY 1)
set(WAMR_BUILD_DEBUG_INTERP 0)
set(WAMR_BUILD_DUMP_CALL_STACK 1)
set(WAMR_BUILD_FAST_INTERP 1)
set(WAMR_BUILD_FAST_JIT 0)
set(WAMR_BUILD_GLOBAL_HEAP_POOL 0)
set(WAMR_BUILD_INTERP 1)
#set(WAMR_BUILD_INVOKE_NATIVE_GENERAL 1) # avoid using asm - it clashes with jpeg
set(WAMR_BUILD_JIT 0)
set(WAMR_BUILD_LIBC_BUILTIN 1)
set(WAMR_BUILD_LIBC_UVWASI 0)
set(WAMR_BUILD_LIBC_WASI 0)
set(WAMR_BUILD_LIB_PTHREAD 0)
set(WAMR_BUILD_LIB_PTHREAD_SEMAPHORE 0)
set(WAMR_BUILD_LIB_WASI_THREADS 0)
set(WAMR_BUILD_MINI_LOADER 0)
set(WAMR_BUILD_MODULE_INST_CONTEXT 0)
set(WAMR_BUILD_MULTI_MODULE 0)
set(WAMR_BUILD_REF_TYPES 0)
set(WAMR_BUILD_REF_TYPES 0)
set(WAMR_BUILD_SHARED_MEMORY 0)
set(WAMR_BUILD_SIMD 1)
set(WAMR_BUILD_TAIL_CALL 1)
set(WAMR_BUILD_THREAD_MGR 0)
set(WAMR_BUILD_WASI_NN 0)
set(WAMR_DISABLE_APP_ENTRY 1)
set(WAMR_DISABLE_HW_BOUND_CHECK 1) # interferes with c++ exceptions
set(WAMR_DISABLE_STACK_HW_BOUND_CHECK 1) # interferes with c++ exceptions
set(WAMR_DISABLE_WAKEUP_BLOCKING_OP 0)

enable_language(ASM)
enable_language(ASM_MASM)

add_compile_definitions("$<$<CONFIG:Debug>:BH_DEBUG=1>")

include("${CMAKE_CURRENT_LIST_DIR}/wamr/build-scripts/runtime_lib.cmake")
file(GLOB_RECURSE iwasm_headers "${CMAKE_CURRENT_LIST_DIR}/wamr/core/*.h")
add_library(iwasm_static STATIC ${WAMR_RUNTIME_LIB_SOURCE} ${iwasm_headers})
target_include_directories(iwasm_static INTERFACE "wamr/core/iwasm/include")
target_link_libraries(iwasm_static INTERFACE ${LLVM_AVAILABLE_LIBS} ${UV_A_LIBS})
target_compile_definitions(iwasm_static PUBLIC WASM_RUNTIME_API_EXTERN= WASM_API_EXTERN= COMPILING_WASM_RUNTIME_API=1)
